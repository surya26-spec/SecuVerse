<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecuVerse // GUARD_VIEW</title>
    <!-- Use fresh cache buster -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=20260124_v11">
</head>

<body>
    <div class="scanlines"></div>
    <div class="mesh-gradient"></div>

    <div class="dashboard-container">
        <div class="header-dash">
            <div>
                <span class="badge">LIVE_MONITORING</span>
                <h1>SecuVerse <span class="text-active">GuardView</span></h1>
                <p style="color: var(--text-muted);">Real-time network traffic analysis and threat detection</p>
            </div>
            <div
                style="display: flex; gap: 10px; background: rgba(0,0,0,0.8); padding: 5px; border: 1px solid var(--text-muted);">
                <a href="/" class="nav-link">ANALYZER</a>
                <a href="/phishing" class="nav-link">PHISHING</a>
                <a href="/honeypot" class="nav-link">HONEYPOT</a>
                <a href="/dashboard" class="nav-link active">GUARD_VIEW</a>
                <a href="/logout" class="nav-link"
                    style="color: var(--neon-red); border-color: var(--neon-red);">LOGOUT</a>
            </div>
        </div>

        <div class="card-grid">
            <div class="dash-card active-status">
                <h3>SYSTEM_STATUS</h3>
                <div class="value">ACTIVE</div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 10px;">
                    <span style="color: var(--neon-green);">‚óè</span> ALL SYSTEMS OPERATIONAL
                </div>
            </div>
            <div class="dash-card info">
                <h3>TOTAL_REQUESTS</h3>
                <div class="value" id="total-reqs">Loading...</div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 10px;">
                    PROCESSED_IN_SESSION
                </div>
            </div>
            <div class="dash-card danger">
                <h3>THREATS_DETECTED</h3>
                <div class="value" id="threat-count">0</div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 10px;">
                    INTRUSION_ATTEMPTS_BLOCKED
                </div>
            </div>
            <div class="dash-card warning">
                <h3>HONEYPOT_HITS</h3>
                <div class="value" id="honey-count">0</div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 10px;">
                    MALICIOUS_ACTORS_TRAPPED
                </div>
            </div>
        </div>

        <h2 class="section-title">ATTACK_SIMULATION_ZONE</h2>
        <div class="dash-card warning" style="margin-bottom: 40px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h3 style="color: #f59e0b;">‚ö†Ô∏è TRIGGER_LIVE_ATTACKS</h3>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px; max-width: 600px;">
                        Safety simulate cyber attacks against this server to verify IDS detection capabilities.
                        <strong>WARNING:</strong> These actions generate real traffic and logs.
                    </p>
                </div>
            </div>

            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button onclick="runAttack('bruteforce')" class="cyber-btn" style="font-size: 1rem;">
                    ‚ö° BRUTE_FORCE
                </button>
                <button onclick="runAttack('portscan')" class="cyber-btn" style="font-size: 1rem;">
                    üîç PORT_SCAN
                </button>
                <button onclick="runAttack('phishing')" class="cyber-btn" style="font-size: 1rem;">
                    üé£ PHISHING
                </button>
                <button onclick="runAttack('injection')" class="cyber-btn" style="font-size: 1rem;">
                    üíâ SQL_INJECTION
                </button>
                <button onclick="run10PartSim()" class="cyber-btn" style="font-size: 1rem;">
                    üìä START_10_PART_MONITOR
                </button>
            </div>
            <div id="sim-output"
                style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.8); border: 1px solid var(--text-muted); font-family: 'VT323', monospace; font-size: 1.2rem; color: var(--neon-green); display: none;">
                <!-- Output here -->
            </div>
        </div>

        <h2 class="section-title">ACTIVE_THREAT_RADAR</h2>
        <div class="chart-glass"
            style="margin-bottom: 20px; height: 450px; display: flex; justify-content: center; align-items: center;">
            <canvas id="radarChart"></canvas>
        </div>

        <h2 class="section-title">CYBER_STREAM</h2>
        <div class="chart-glass" style="margin-bottom: 20px; height: 350px;">
            <canvas id="lineChart"></canvas>
        </div>

        <!-- Status Grid -->
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 40px;">
            <!-- Loop for 10 Parts generated by JS -->
            <div id="status-grid-container" style="display: contents;">
                <!-- Filled by JS -->
            </div>
        </div>

        <h2 class="section-title">ATTACK_ANALYSIS</h2>
        <div class="card-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
            <div class="dash-card danger" style="padding: 15px;">
                <h3 style="font-size: 0.8rem;">BRUTE_FORCE</h3>
                <div class="value" id="bf-count" style="font-size: 2rem;">0</div>
            </div>
            <div class="dash-card warning" style="padding: 15px;">
                <h3 style="font-size: 0.8rem;">PORT_SCANS</h3>
                <div class="value" id="scan-count" style="font-size: 2rem;">0</div>
            </div>
            <div class="dash-card info" style="padding: 15px;">
                <h3 style="font-size: 0.8rem;">SQL_INJECTION</h3>
                <div class="value" id="sqli-count" style="font-size: 2rem;">0</div>
            </div>
            <div class="dash-card active-status" style="padding: 15px;">
                <h3 style="font-size: 0.8rem;">PHISHING_CHECKS</h3>
                <div class="value" id="phish-count" style="font-size: 2rem;">0</div>
            </div>
        </div>

        <h2 class="section-title">TRAFFIC_ANALYSIS</h2>
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-bottom: 50px;">
            <div class="chart-glass">
                <canvas id="typeChart"></canvas>
            </div>
            <div class="chart-glass">
                <canvas id="protoChart"></canvas>
            </div>
        </div>

        <h2 class="section-title">RECENT_ACTIVITY_LOG</h2>
        <div class="chart-glass" style="height: auto; padding: 0; overflow: hidden;">
            <div style="overflow-x: auto;">
                <table class="glass-table">
                    <thead>
                        <tr>
                            <th>TIMESTAMP</th>
                            <th>SOURCE_IP</th>
                            <th>PROTOCOL</th>
                            <th>STATUS</th>
                            <th>INFO</th>
                        </tr>
                    </thead>
                    <tbody id="logs-body">
                        <!-- Data will be populated via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global Chart Defaults for Hacker Theme
        Chart.defaults.color = '#228b22';
        Chart.defaults.borderColor = 'rgba(57, 255, 20, 0.1)';
        Chart.defaults.font.family = "'Share Tech Mono', monospace";

        let typeChartInstance = null;
        let protoChartInstance = null;
        let lineChartInstance = null;
        let radarChartInstance = null;

        function initCharts() {
            // Type Chart
            const ctx1 = document.getElementById('typeChart').getContext('2d');
            typeChartInstance = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['NORMAL', 'INTRUSION'],
                    datasets: [{
                        data: [1, 0],
                        backgroundColor: ['#39ff14', '#ff073a'],
                        borderColor: ['#000', '#000'],
                        borderWidth: 2,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: {
                            display: true,
                            text: 'TRAFFIC_CLASSIFICATION',
                            color: '#39ff14',
                            font: { size: 16 }
                        }
                    },
                    cutout: '70%',
                }
            });

            // Protocol Chart
            const ctx2 = document.getElementById('protoChart').getContext('2d');

            // Hacker Gradients
            const gTCP = ctx2.createLinearGradient(0, 0, 0, 300); gTCP.addColorStop(0, '#39ff14'); gTCP.addColorStop(1, 'rgba(57,255,20,0.1)');
            const gUDP = ctx2.createLinearGradient(0, 0, 0, 300); gUDP.addColorStop(0, '#00f3ff'); gUDP.addColorStop(1, 'rgba(0,243,255,0.1)');
            const gICMP = ctx2.createLinearGradient(0, 0, 0, 300); gICMP.addColorStop(0, '#ff073a'); gICMP.addColorStop(1, 'rgba(255,7,58,0.1)');

            protoChartInstance = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['TCP', 'UDP', 'ICMP'],
                    datasets: [{
                        label: 'PACKETS',
                        data: [0, 0, 0],
                        backgroundColor: [gTCP, gUDP, gICMP],
                        barThickness: 50
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(57,255,20,0.1)' } },
                        x: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'PROTOCOL_DISTRIBUTION', color: '#39ff14', font: { size: 16 } }
                    }
                }
            });

            // --- Multi-Line Monitor Chart ---
            const ctx3 = document.getElementById('lineChart').getContext('2d');

            // 10 Shades of Hacker
            const lineColors = [
                '#39ff14', '#00f3ff', '#ff073a', '#ffff00', '#ff00ff',
                '#00ff00', '#00cccc', '#cc0000', '#cccc00', '#cc00cc'
            ];

            const datasets = [];
            for (let i = 1; i <= 10; i++) {
                datasets.push({
                    label: `NODE_${i}`,
                    data: [],
                    borderColor: lineColors[i - 1],
                    backgroundColor: lineColors[i - 1],
                    borderWidth: 1,
                    tension: 0, /* Angular for tech feel */
                    pointRadius: 0
                });
            }

            lineChartInstance = new Chart(ctx3, {
                type: 'line',
                data: { labels: [], datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(57,255,20,0.1)' } },
                        x: { grid: { color: 'rgba(57,255,20,0.1)' } }
                    },
                    plugins: {
                        title: { display: true, text: 'REAL-TIME_CYBER_STREAM', color: '#39ff14' },
                        legend: { labels: { color: '#228b22', font: { size: 10 }, boxWidth: 8 } }
                    },
                    interaction: { mode: 'index', intersect: false },
                }
            });

            // --- Radar Chart ---
            const ctx4 = document.getElementById('radarChart').getContext('2d');
            radarChartInstance = new Chart(ctx4, {
                type: 'radar',
                data: {
                    labels: ['NODE_1', 'NODE_2', 'NODE_3', 'NODE_4', 'NODE_5', 'NODE_6', 'NODE_7', 'NODE_8', 'NODE_9', 'NODE_10'],
                    datasets: [{
                        label: 'ATTACK_INTENSITY',
                        data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        fill: true,
                        backgroundColor: 'rgba(255, 7, 58, 0.2)',
                        borderColor: '#ff073a',
                        pointBackgroundColor: '#ff073a'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(57,255,20,0.2)' },
                            grid: { color: 'rgba(57,255,20,0.2)' },
                            pointLabels: { color: '#39ff14', font: { size: 10 } },
                            ticks: { showLabelBackdrop: false, color: '#228b22' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#ff073a' } },
                        title: { display: true, text: 'THREAT_RADAR', color: '#fff' }
                    }
                }
            });
        }

        // Functions for animating values (reusing existing logic)
        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);
            const timer = setInterval(function () {
                current += increment;
                obj.innerHTML = current;
                if (current == end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }

        function runAttack(type) {
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span style="color:white;">WAIT...</span>`;
            btn.disabled = true;

            // Map type to correct endpoint
            let endpoint = '';
            if (type === 'bruteforce') endpoint = '/api/simulate/bruteforce';
            else if (type === 'portscan') endpoint = '/api/simulate/portscan';
            else if (type === 'phishing') endpoint = '/api/simulate/phishing';
            else if (type === 'injection') endpoint = '/api/simulate/injection';

            fetch(endpoint, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    const output = document.getElementById('sim-output');
                    output.style.display = 'block';
                    output.innerHTML = `> COMMAND: ${type.toUpperCase()}<br>> STATUS: EXECUTED<br>> PACKETS_SENT: ${data.packets_sent || 'N/A'}<br>> MESSAGE: ${data.message || 'Success'}`;

                    // Reset button
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 2000);
                })
                .catch(err => {
                    console.error("Attack failed", err);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        }

        function run10PartSim() {
            const btn = event.target.closest('button');
            btn.disabled = true;

            fetch('/api/simulate/10parts', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    const output = document.getElementById('sim-output');
                    output.style.display = 'block';
                    output.innerHTML = `> COMMAND: 10_PART_MONITOR_SIM<br>> STATUS: ACTIVE<br>> MESSAGE: ${data.message}`;
                    setTimeout(() => btn.disabled = false, 5000);
                })
                .catch(err => {
                    console.error("Simulation failed", err);
                    btn.disabled = false;
                });
        }

        function updateStats() {
            fetch('/api/stats')
                .then(res => res.json())
                .then(data => {
                    // Update Charts Logic (keeping same structure as before)
                    const normal = data.type_counts['Normal'] || 0;
                    const intrusion = data.type_counts['Intrusion'] || 0;
                    if (typeChartInstance) {
                        typeChartInstance.data.datasets[0].data = [normal, intrusion];
                        typeChartInstance.update('none');
                    }

                    // ... (rest of logic similar but simplified for brevity)
                    const tcp = data.proto_counts['tcp'] || 0;
                    const udp = data.proto_counts['udp'] || 0;
                    const icmp = data.proto_counts['icmp'] || 0;
                    if (protoChartInstance) {
                        protoChartInstance.data.datasets[0].data = [tcp, udp, icmp];
                        protoChartInstance.update('none');
                    }

                    const bf = data.type_counts['Brute Force'] || 0;
                    const sqli = data.type_counts['SQL Injection'] || 0;
                    const scan = data.type_counts['Port Scan'] || 0;
                    const phish = data.type_counts['Phishing'] || 0;
                    const honey = data.type_counts['Honeypot'] || 0;

                    document.getElementById('total-reqs').innerText = normal + intrusion + bf + sqli + scan + phish + honey;
                    document.getElementById('threat-count').innerText = intrusion + scan + sqli + bf;
                    document.getElementById('honey-count').innerText = honey;

                    document.getElementById('bf-count').innerText = bf;
                    document.getElementById('sqli-count').innerText = sqli;
                    document.getElementById('scan-count').innerText = scan;
                    document.getElementById('phish-count').innerText = phish;
                });
        }

        function updateLineChart() {
            if (!lineChartInstance) return;
            fetch('/api/part_stats').then(res => res.json()).then(data => {
                const times = Object.keys(data).sort().slice(-20);
                lineChartInstance.data.labels = times;
                for (let i = 0; i < 10; i++) {
                    const ip = `192.168.1.${i + 1}`;
                    lineChartInstance.data.datasets[i].data = times.map(t => data[t][ip] || 0);
                }
                lineChartInstance.update('none');
            });
        }

        function updateStatusGrid() {
            fetch('/api/part_status').then(res => res.json()).then(data => {
                const container = document.getElementById('status-grid-container');
                if (container.children.length === 0) {
                    for (let i = 1; i <= 10; i++) {
                        const div = document.createElement('div');
                        div.id = `status-part-${i}`;
                        // Default style defined in JS for grid items, matching CSS
                        div.className = 'dash-card'; // Reuse dash-card style
                        div.style.padding = '10px';
                        div.style.minHeight = 'auto';
                        div.innerHTML = `<div style="font-size: 0.8rem; color: var(--text-muted);">NODE_${i}</div><div class="status-text" style="font-weight: bold; color: var(--neon-green);">NORMAL</div>`;
                        container.appendChild(div);
                    }
                }

                for (let i = 1; i <= 10; i++) {
                    const ip = `192.168.1.${i}`;
                    const status = data[ip] || 'Normal';
                    const el = document.getElementById(`status-part-${i}`);
                    const textEl = el.querySelector('.status-text');

                    if (status === 'Intrusion' || status === 'Attack') {
                        el.style.borderTop = '3px solid var(--neon-red)';
                        textEl.innerText = 'ATTACK';
                        textEl.style.color = 'var(--neon-red)';
                        textEl.style.textShadow = '0 0 5px var(--neon-red)';
                    } else {
                        el.style.borderTop = '3px solid var(--neon-green)';
                        textEl.innerText = 'NORMAL';
                        textEl.style.color = 'var(--neon-green)';
                        textEl.style.textShadow = 'none';
                    }
                }
            });
        }

        function updateRadarChart() {
            if (!radarChartInstance) return;
            fetch('/api/attack_stats').then(res => res.json()).then(data => {
                const arr = [];
                for (let i = 1; i <= 10; i++) {
                    const ip = `192.168.1.${i}`;
                    arr.push(data[ip] || 0);
                }
                radarChartInstance.data.datasets[0].data = arr;
                radarChartInstance.update('none');
            });
        }

        function updateLogs() {
            fetch('/api/live-data').then(res => res.json()).then(data => {
                const tbody = document.getElementById('logs-body');
                if (!data.logs || data.logs.length === 0) return;
                tbody.innerHTML = '';
                data.logs.slice(0, 10).forEach(log => {
                    const tr = document.createElement('tr');
                    const color = log.type === 'Intrusion' ? 'var(--neon-red)' : 'var(--neon-green)';
                    tr.innerHTML = `
                        <td>${log.timestamp}</td>
                        <td>${log.src_ip}</td>
                        <td>${log.protocol}</td>
                        <td style="color: ${color}">${log.type.toUpperCase()}</td>
                        <td>${log.details || '-'}</td>
                     `;
                    tbody.appendChild(tr);
                });
            });
        }

        // Init and Intervals
        initCharts();
        setInterval(updateStats, 2000);
        setInterval(updateLineChart, 2000);
        setInterval(updateStatusGrid, 2000);
        setInterval(updateLogs, 2000);
        setInterval(updateRadarChart, 2000);
        updateStats(); updateLineChart(); updateStatusGrid(); updateLogs(); updateRadarChart();
    </script>
</body>

</html>